<!DOCTYPE html>
<html lang="en" ng-app="appMain">
<head>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	
	<link rel="stylesheet" type="text/css" href="bower_components/gridism/gridism.css" />
	<link rel="stylesheet" type="text/css" href="bower_components/github-markdown-css/github-markdown.css" />

	<title></title>

	<script>
		
		blogConfig = {
			
			ioContentSubAccountKey: 'nl7bwlc4txh2uvw3s6h4gcclgb',
			ioContentContentType: 'blog-article',
			disqusShortName: 'iocontent',
		}
		
	</script>

</head>
<body class="markdown-body">

	<div ng-view></div>

	<!-- 
	Load disqus scripts - note that initial config is commented out - all is handled
	in reset on content load 
	-->

	<div id="disqus_thread"></div>
	<script>
		
		/**
		* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
		*/
		
		(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		
			s.src = '//' + blogConfig.disqusShortName + '.disqus.com/embed.js';
			
			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	<!-- Load I/O content api -->

	<script src="bower_components/io-content-js/dist/io-content.js"></script>

	<!-- Load Angular -->

	<script src="bower_components/angular/angular.min.js"></script>
	<script src="bower_components/angular-route/angular-route.min.js"></script>
	<script src="bower_components/angular-touch/angular-touch.min.js"></script>
	<script src="bower_components/angular-sanitize/angular-sanitize.min.js"></script>
	
	<!-- Angular app -->

	<script>

		(function () {

			'use strict';
			
			angular
			
			.module('appMain', ['ng', 'ngRoute', 'ngTouch', 'ngSanitize'])
			.config(['$routeProvider', '$locationProvider', function ($routeProvider, $locationProvider) {
	
				$routeProvider
				.when('/', {
					templateUrl: 'template.html',
					controller: 'blogController'
				})
				.when('/blog/:contentKey/:contentSeoTitle', {
					templateUrl: 'template.html',
					controller: 'blogController'
				})
				.otherwise({
					redirectTo: '/'
				});
	
				// html5Mode required for querystring parameter search ($location)
	
				$locationProvider.html5Mode(false);
			}]);
		})();

		(function () {

			'use strict';

			angular.module('appMain')

				.controller('blogController', ['$scope', '$routeParams', '$location', function ($scope, $routeParams, $location) {
					
					// Helper function for creating pretty seo text in url
					
					var toHypenCase = function (str) {
						
						return str.replace(/\s+/g, '-').toLowerCase();
					}
					
					// Common url string generation from blog entry properties
					
					var getBlogUrl = function (contentKey, contentTitle) {
						
						return '/#/blog/' + contentKey + '/' + toHypenCase(contentTitle);
					}
					
					// Simple routing mechanism using Angulars location service
					
					var contentKey = $routeParams.contentKey; 

					console.log('contentKey', contentKey)

					// Set up I/O Content ContentClient and configure sub account and 
					// content type.

					var contentClient = new ContentClient();

					contentClient.contentClientBaseParameters.subAccountKey = blogConfig.ioContentSubAccountKey;
					contentClient.contentClientBaseParameters.contentType = blogConfig.ioContentContentType;

					$scope.contentCurrent = {};

					$scope.blog = {

						contentEntryList: [],
						
						loadSingleBlogEntry: function (contentKey) {

							console.log('load')

							// Load full content for a single blog article

							var apiCallBack = function (responseJson) {

								var responseObj = JSON.parse(responseJson);

								// In JS api, an array of content objects is always returned, even
								// where the query would always limit the result set to a single content entity
								
								var contentCurrent = responseObj[0];

								$scope.contentCurrent = contentCurrent;
								
								// https://help.disqus.com/customer/portal/articles/472107-using-disqus-on-ajax-sites
								
								// Discuss needs a full url and loads comments based on the id given. Tweak these values
								// incase of issue
						
								DISQUS.reset({
									reload: true,
									config: function () {  
										this.page.identifier = 'id-' + contentCurrent.key;  
										this.page.url = getBlogUrl(contentCurrent.key, toHypenCase(contentCurrent.title));
										this.page.title = contentCurrent.title;
										this.language = 'en';
									}
								});
								
								// Scope apply as this callback as async event
								// not monitored by Angular
								
								$scope.$apply();
								
								// Doc title needs to be set in plain JS as is out of scope of
								// view controller
								
								if(contentCurrent && contentCurrent.title)
								{
									document.title = contentCurrent.title;
								}
							}
							
							// Construct single blog entry query and fetch
							
							var query = 'key.equals=' + contentKey + '&markdownToHtml=true';

							contentClient.get(query, apiCallBack);
						},
						loadContentEntryList: function() {
							
							// Load a list of blog artciles to allow user to navigate
							
							var blog = this;
							
							var apiCallBack = function (responseJson) {

								blog.contentEntryList = JSON.parse(responseJson); // [] of content entries
								
								for(var i= 0; i < blog.contentEntryList.length; i++)
								{
									blog.contentEntryList[i].blogUrl = getBlogUrl(blog.contentEntryList[i].key, toHypenCase(blog.contentEntryList[i].title));
								}
								
								// If content key is not loaded on the route, load the most recent
								// blog entry from the list
								
								var loadKey = contentKey != null ? contentKey : blog.contentEntryList[0].key;
								
								if(!$scope.contentKey)
								{
									$scope.blog.loadSingleBlogEntry(loadKey);
								}
								
								// Scope apply as this callback as async event
								// not monitored by Angular
								
								$scope.$apply();
							}
							
							// Since we are simply pulling all articles for purpose of creating side nav, 
							// only need to specify.
							
							var query = 'orderByDescending=publicPublishDate&limit=20';

							contentClient.get(query, apiCallBack);
						}
					}

					// Init

					$scope.blog.loadContentEntryList();
					
					if($scope.contentKey)
					{
						$scope.blog.loadSingleBlogEntry($scope.contentKey);
					}
				}]);

		})();


	</script>
</body>